name: CI and Deploy To Azure VM

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Secret Leak Guard
        run: bash scripts/security/check_secret_leaks.sh

      - name: Run Tests
        run: pytest -q

  deploy:
    name: Deploy To VM
    needs: ci
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH Key
        env:
          VM_SSH_PRIVATE_KEY: ${{ secrets.VM_SSH_PRIVATE_KEY }}
        run: |
          test -n "$VM_SSH_PRIVATE_KEY"
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "$VM_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Add VM Host Key
        env:
          VM_HOST: ${{ secrets.VM_HOST }}
          VM_PORT: ${{ secrets.VM_PORT }}
        run: |
          test -n "$VM_HOST"
          PORT="${VM_PORT:-22}"
          ssh-keyscan -p "$PORT" -H "$VM_HOST" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy To VM
        env:
          VM_HOST: ${{ secrets.VM_HOST }}
          VM_USER: ${{ secrets.VM_USER }}
          VM_PORT: ${{ secrets.VM_PORT }}
          VM_APP_DIR: ${{ secrets.VM_APP_DIR }}
          VM_SERVICE_NAME: ${{ secrets.VM_SERVICE_NAME }}
          HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_URL }}
        run: |
          export APP_DIR="${VM_APP_DIR:-}"
          export SERVICE_NAME="${VM_SERVICE_NAME:-}"
          bash scripts/azure/deploy_vm_code.sh
